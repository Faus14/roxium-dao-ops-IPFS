import { Response, isWebSocketUpgrade, normalizeMethod, getServerUpgradeHeaders } from '@libp2p/http-utils';
import { RequestWebSocket } from '@libp2p/http-websocket';
import { InvalidParametersError } from '@libp2p/interface';
import { WEBSOCKET_HANDLER } from '../constants.js';
import { initializeRoute } from './utils.js';
/**
 * Negotiate a connection upgrade to the WebSocket protocol and call the passed
 * handler
 */
export function webSocketRoute(route) {
    const method = normalizeMethod(route.method, ['GET']);
    if (route.fallback == null && method.filter(method => method !== 'GET').length > 0) {
        throw new InvalidParametersError('WebSocket handlers only support the GET HTTP method');
    }
    const output = {
        ...route,
        init: (components) => {
            const next = initializeRoute(route, components);
            // allow invoking the handler with a pre-upgraded socket
            output[WEBSOCKET_HANDLER] = next.handler;
            return async (req) => {
                // check upgrade has been requested
                if (!isWebSocketUpgrade(req.method, req.headers)) {
                    if (route?.fallback != null) {
                        return route.fallback(req);
                    }
                    return new Response(null, {
                        status: 400
                    });
                }
                const transform = new TransformStream();
                try {
                    const res = new Response(transform.readable, {
                        status: 101,
                        headers: await getServerUpgradeHeaders(req.headers)
                    });
                    const ws = new RequestWebSocket(req, transform.writable, route);
                    next.handler(ws);
                    return res;
                }
                catch (err) {
                    return new Response(null, {
                        status: 500
                    });
                }
            };
        }
    };
    return output;
}
//# sourceMappingURL=websocket.js.map